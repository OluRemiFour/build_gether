import {Opik,OpikSpanType}from'opik';var R=class R{static getInstance(e){return R.instance||(R.instance=new Opik(e)),R.instance}};R.instance=null;var A=R;var x=a=>{if(a)return a.replace(/^models\//,"")};var G=a=>a!==null&&typeof a=="object"&&Symbol.asyncIterator in a&&typeof a[Symbol.asyncIterator]=="function",P=(a,e="")=>{let o={};for(let[n,t]of Object.entries(a)){let i=e?`${e}.${n}`:n;t&&typeof t=="object"&&!Array.isArray(t)&&!(t instanceof Date)?Object.assign(o,P(t,i)):o[i]=t;}return o};var E=a=>{let e=a.model;e&&(e=x(e));let o={};"contents"in a&&(o.contents=a.contents),"prompt"in a&&(o.prompt=a.prompt),"config"in a&&(o.config=a.config);let n={};if("config"in a&&typeof a.config=="object"&&a.config!==null){let t=a.config;"systemInstruction"in t&&(n.systemInstruction=t.systemInstruction),"generationConfig"in t&&(n.generationConfig=t.generationConfig),"safetySettings"in t&&(n.safetySettings=t.safetySettings),"tools"in t&&(n.tools=t.tools),"toolConfig"in t&&(n.toolConfig=t.toolConfig);let i=["temperature","maxOutputTokens","topP","topK","candidateCount","stopSequences"];for(let c of i)c in t&&(n[c]=t[c]);}return {model:e,input:o,modelParameters:n}},O=a=>{if(!a||typeof a!="object")return;let e=a;if("candidates"in e&&Array.isArray(e.candidates))return e.candidates.length===0?void 0:{candidates:e.candidates}},D=a=>{if(!a||typeof a!="object")return;let e=a,o="usageMetadata"in e&&e.usageMetadata||"usage_metadata"in e&&e.usage_metadata||"usage"in e&&e.usage;if(!o||typeof o!="object")return;let n=o,t={};(typeof n.promptTokenCount=="number"||typeof n.prompt_token_count=="number")&&(t.prompt_tokens=n.promptTokenCount||n.prompt_token_count),(typeof n.candidatesTokenCount=="number"||typeof n.candidates_token_count=="number")&&(t.completion_tokens=n.candidatesTokenCount||n.candidates_token_count),(typeof n.totalTokenCount=="number"||typeof n.total_token_count=="number")&&(t.total_tokens=n.totalTokenCount||n.total_token_count),(typeof n.cachedContentTokenCount=="number"||typeof n.cached_content_token_count=="number")&&(t.cached_content_tokens=n.cachedContentTokenCount||n.cached_content_token_count);let i={...n};delete i.promptTokensDetails,delete i.prompt_tokens_details,delete i.candidatesTokensDetails,delete i.candidates_tokens_details;let c=P(i,"original_usage");for(let[l,s]of Object.entries(c))typeof s=="number"&&(t[l]=s);return Object.keys(t).length>0?t:void 0},M=a=>{if(!a||typeof a!="object")return {isToolCall:false,data:""};let e=a;if("candidates"in e&&Array.isArray(e.candidates)&&e.candidates.length>0){let o=e.candidates[0];if(o&&"content"in o&&o.content&&typeof o.content=="object"){let n=o.content;if("parts"in n&&Array.isArray(n.parts)&&n.parts.length>0){let t=n.parts[0];if("functionCall"in t||"function_call"in t)return {isToolCall:true,data:JSON.stringify(t.functionCall||t.function_call)};if("text"in t&&typeof t.text=="string")return {isToolCall:false,data:t.text}}}}return {isToolCall:false,data:""}},C=a=>{if(!a||typeof a!="object")return {model:void 0,metadata:void 0};let e=a,o,n={};if("modelVersion"in e&&typeof e.modelVersion=="string"?o=x(e.modelVersion):"model_version"in e&&typeof e.model_version=="string"&&(o=x(e.model_version)),"candidates"in e&&Array.isArray(e.candidates)&&e.candidates.length>0){let t=e.candidates[0];"safetyRatings"in t?n.safety_ratings=t.safetyRatings:"safety_ratings"in t&&(n.safety_ratings=t.safety_ratings),"finishReason"in t?n.finish_reason=t.finishReason:"finish_reason"in t&&(n.finish_reason=t.finish_reason);}return "promptFeedback"in e?n.prompt_feedback=e.promptFeedback:"prompt_feedback"in e&&(n.prompt_feedback=e.prompt_feedback),n.created_from="genai",{model:o,metadata:Object.keys(n).length>0?n:void 0}};var v=(a,e)=>(...o)=>{var g;let{model:n,input:t,modelParameters:i}=E(o[0]),{tags:c=[],...l}=(g=e==null?void 0:e.traceMetadata)!=null?g:{},s={name:e.generationName,startTime:new Date,input:t,model:n,provider:e.provider,metadata:{...l,...i},tags:["genai",...c]},r,y=!!(e!=null&&e.parent);e!=null&&e.parent?r=e.parent:r=e.client.trace(s);try{let d=a(...o);if(G(d))return N(d,r,y,s);if(d instanceof Promise)return d.then(p=>{if(G(p))return N(p,r,y,s);let F=O(p),S=D(p),{model:$,metadata:K}=C(p),L=r.span({...s,output:F,endTime:new Date,usage:S,model:$||s.model,type:OpikSpanType.Llm,metadata:{...s.metadata,...K,usage:S}}),j=p;return j.functionCalls&&Array.isArray(j.functionCalls)&&j.functionCalls.forEach(h=>{L.span({name:`function_call: ${h.name}`,startTime:new Date,endTime:new Date,input:{arguments:h.args},output:{function_name:h.name},type:OpikSpanType.Tool,metadata:{function_name:h.name,function_arguments:h.args}});}),y||r.update({output:F,endTime:new Date}),p}).catch(p=>{throw I(p,r,s),p});let k=O(d),m=D(d),{model:b,metadata:f}=C(d),u=r.span({...s,output:k,endTime:new Date,usage:m,model:b||s.model,type:OpikSpanType.Llm,metadata:{...s.metadata,...f,usage:m}}),_=d;return _.functionCalls&&Array.isArray(_.functionCalls)&&_.functionCalls.forEach(w=>{u.span({name:`function_call: ${w.name}`,startTime:new Date,endTime:new Date,input:{arguments:w.args},output:{function_name:w.name},type:OpikSpanType.Tool,metadata:{function_name:w.name,function_arguments:w.args}});}),y||r.update({output:k,endTime:new Date}),d}catch(d){throw I(d,r,s),d}};function N(a,e,o,n){async function*t(){var y,g,d,k;let i=[],c=[],l,s={},r;try{for await(let f of a){i.push(f);let u=M(f);u.isToolCall||c.push(u.data),yield f;}let m=i[i.length-1];if(m){l=D(m),r=C(m);let f=c.join(""),u=O(m);if(u!=null&&u.candidates){s={candidates:structuredClone(u.candidates)};let _=s;(k=(d=(g=(y=_.candidates)==null?void 0:y[0])==null?void 0:g.content)==null?void 0:d.parts)!=null&&k[0]&&(_.candidates[0].content.parts[0].text=f);}}let b=e.span({...n,output:s,endTime:new Date,usage:l,model:(r==null?void 0:r.model)||n.model,type:OpikSpanType.Llm,metadata:{...n.metadata,...r==null?void 0:r.metadata,usage:l}});if(m&&typeof m=="object"){let f=m;f.functionCalls&&Array.isArray(f.functionCalls)&&f.functionCalls.forEach(u=>{b.span({name:`function_call: ${u.name}`,startTime:new Date,endTime:new Date,input:{arguments:u.args},output:{function_name:u.name},type:OpikSpanType.Tool,metadata:{function_name:u.name,function_arguments:u.args}});});}o||e.update({output:s,endTime:new Date});}catch(m){throw I(m,e,n),m}}return t()}var I=(a,e,o)=>{var n;e.span({...o,endTime:new Date,type:OpikSpanType.Llm,errorInfo:{message:a.message,exceptionType:a.name,traceback:(n=a.stack)!=null?n:""}}),e.end();};var V=a=>"vertexai"in a&&a.vertexai?"google_vertexai":"google_ai",z=(a,e)=>{let o=V(a);return new Proxy(a,{get(n,t,i){var g,d,k;let c=n[t],l=((g=a.constructor)==null?void 0:g.name)||"Gemini",r={generationName:(d=e==null?void 0:e.generationName)!=null?d:`${l}.${t.toString()}`,client:(k=e==null?void 0:e.client)!=null?k:A.getInstance(),parent:e==null?void 0:e.parent,traceMetadata:e==null?void 0:e.traceMetadata,provider:o};return t==="flush"?r.client.flush.bind(r.client):typeof c=="function"?v(c.bind(n),r):c&&!Array.isArray(c)&&!(c instanceof Date)&&typeof c=="object"?new Proxy(c,{get(m,b,f){let u=m[b];return typeof u=="function"?v(u.bind(m),r):Reflect.get(m,b,f)}}):Reflect.get(n,t,i)}})};
export{z as trackGemini};